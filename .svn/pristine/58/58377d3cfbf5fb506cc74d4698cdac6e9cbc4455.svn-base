<?php
/**
 * Shared helpers for Nonprofit Manager email handling.
 *
 * @package NonprofitManager
 */

defined( 'ABSPATH' ) || exit;

/**
 * Default email settings.
 *
 * @return array
 */
function npmp_email_default_settings() {
	return array(
		'provider'        => 'wordpress',
		'from_email'      => get_option( 'admin_email' ),
		'from_name'       => get_option( 'blogname' ),
		'force_from'      => 1,
		'set_return_path' => 1,
		'smtp'            => array(
			'host'       => '',
			'port'       => 587,
			'encryption' => 'tls',
			'auth'       => 1,
			'username'   => '',
			'password'   => '',
			'auto_tls'   => 1,
		),
		'aws'             => array(
			'region' => 'us-east-1',
		),
	);
}

/**
 * Retrieve email settings (with migration from legacy options).
 *
 * @return array
 */
function npmp_email_get_settings() {
	$settings = get_option( 'npmp_email_settings' );

	if ( ! is_array( $settings ) ) {
		$settings = npmp_email_default_settings();
		npmp_email_migrate_legacy_settings( $settings );
	} else {
		$defaults           = npmp_email_default_settings();
		$settings           = wp_parse_args( $settings, $defaults );
		$settings['smtp']   = wp_parse_args( $settings['smtp'], $defaults['smtp'] );
		$settings['aws']    = wp_parse_args( $settings['aws'], $defaults['aws'] );
		$settings['provider'] = in_array( $settings['provider'], array( 'wordpress', 'smtp', 'aws_ses' ), true )
			? $settings['provider']
			: 'wordpress';
	}

	return $settings;
}

/**
 * Persist settings to the database.
 *
 * @param array $settings Sanitised settings.
 * @return void
 */
function npmp_email_update_settings( $settings ) {
	update_option( 'npmp_email_settings', $settings );
}

/**
 * Attempt to migrate legacy option values.
 *
 * @param array &$settings Current settings array (passed by reference).
 * @return void
 */
function npmp_email_migrate_legacy_settings( &$settings ) {
	$method     = get_option( 'npmp_email_method', 'wp_mail' );
	$from_email = get_option( 'npmp_email_from_email', get_option( 'admin_email' ) );
	$from_name  = get_option( 'npmp_email_from_name', get_option( 'blogname' ) );

	$settings['from_email'] = $from_email;
	$settings['from_name']  = $from_name;

	if ( 'smtp' === $method ) {
		$settings['provider']          = 'smtp';
		$settings['smtp']['host']      = get_option( 'npmp_smtp_host', '' );
		$settings['smtp']['port']      = (int) get_option( 'npmp_smtp_port', 587 );
		$settings['smtp']['encryption'] = get_option( 'npmp_smtp_encryption', 'tls' );
		$settings['smtp']['auth']      = (int) get_option( 'npmp_smtp_auth', 1 );
		$settings['smtp']['username']  = get_option( 'npmp_smtp_username', '' );
		$settings['smtp']['password']  = get_option( 'npmp_smtp_password', '' );
	}
}

/**
 * Provider choices for the settings select.
 *
 * @return array
 */
function npmp_email_get_provider_choices() {
	return array(
		'wordpress' => __( 'WordPress (wp_mail)', 'nonprofit-manager' ),
		'smtp'      => __( 'Custom SMTP', 'nonprofit-manager' ),
		'aws_ses'   => __( 'Amazon SES (SMTP credentials)', 'nonprofit-manager' ),
	);
}

/**
 * Retrieve available AWS regions.
 *
 * @return array
 */
function npmp_email_get_aws_regions() {
	return array(
		'us-east-1'      => __( 'US East (N. Virginia)', 'nonprofit-manager' ),
		'us-east-2'      => __( 'US East (Ohio)', 'nonprofit-manager' ),
		'us-west-1'      => __( 'US West (N. California)', 'nonprofit-manager' ),
		'us-west-2'      => __( 'US West (Oregon)', 'nonprofit-manager' ),
		'ca-central-1'   => __( 'Canada (Central)', 'nonprofit-manager' ),
		'eu-central-1'   => __( 'Europe (Frankfurt)', 'nonprofit-manager' ),
		'eu-west-1'      => __( 'Europe (Ireland)', 'nonprofit-manager' ),
		'eu-west-2'      => __( 'Europe (London)', 'nonprofit-manager' ),
		'eu-west-3'      => __( 'Europe (Paris)', 'nonprofit-manager' ),
		'eu-north-1'     => __( 'Europe (Stockholm)', 'nonprofit-manager' ),
		'ap-south-1'     => __( 'Asia Pacific (Mumbai)', 'nonprofit-manager' ),
		'ap-northeast-1' => __( 'Asia Pacific (Tokyo)', 'nonprofit-manager' ),
		'ap-northeast-2' => __( 'Asia Pacific (Seoul)', 'nonprofit-manager' ),
		'ap-southeast-1' => __( 'Asia Pacific (Singapore)', 'nonprofit-manager' ),
		'ap-southeast-2' => __( 'Asia Pacific (Sydney)', 'nonprofit-manager' ),
		'sa-east-1'      => __( 'South America (Sao Paulo)', 'nonprofit-manager' ),
	);
}

/**
 * Generate the Amazon SES SMTP host for a region.
 *
 * @param string $region AWS region.
 * @return string
 */
function npmp_email_get_aws_smtp_host( $region ) {
	$region = sanitize_key( $region );
	return sprintf( 'email-smtp.%s.amazonaws.com', $region );
}

/**
 * Store the latest email result.
 *
 * @param string $status  success|error|warning.
 * @param array  $details Additional context.
 * @return void
 */
function npmp_email_record_result( $status, $details = array() ) {
	$log = array(
		'status'    => sanitize_key( $status ),
		'details'   => $details,
		'timestamp' => time(),
	);

	update_option( 'npmp_email_last_result', $log );
}

/**
 * Retrieve the most recent email result.
 *
 * @return array
 */
function npmp_email_get_last_result() {
	$log = get_option( 'npmp_email_last_result', array() );
	if ( ! isset( $log['status'] ) ) {
		return array();
	}
	return $log;
}

/**
 * Determine if the current provider requires SMTP credentials.
 *
 * @param array $settings Settings array.
 * @return bool
 */
function npmp_email_provider_requires_smtp( $settings ) {
	return in_array( $settings['provider'], array( 'smtp', 'aws_ses' ), true );
}

/**
 * Helper to detect if SMTP configuration appears complete.
 *
 * @param array $settings Settings array.
 * @return bool
 */
function npmp_email_smtp_is_configured( $settings ) {
	if ( ! npmp_email_provider_requires_smtp( $settings ) ) {
		return true;
	}

	$host     = trim( $settings['smtp']['host'] );
	$username = trim( $settings['smtp']['username'] );
	$password = trim( $settings['smtp']['password'] );
	$port     = (int) $settings['smtp']['port'];

	return ( '' !== $host && '' !== $username && '' !== $password && $port > 0 );
}
