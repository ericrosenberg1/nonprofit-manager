<?php
// includes/npmp-email-settings.php
defined( 'ABSPATH' ) || exit;

/**
 * Render a delivery status overview card.
 *
 * @param array $settings    Current email settings.
 * @param array $last_result Last delivery result summary.
 * @return void
 */
function npmp_email_render_status_overview( $settings, $last_result ) {
	$provider_choices = npmp_email_get_provider_choices();
	$provider_key     = $settings['provider'] ?? 'wordpress';
	$provider_label   = $provider_choices[ $provider_key ] ?? ucfirst( $provider_key );

	$requires_smtp = npmp_email_provider_requires_smtp( $settings );
	$smtp_ready    = $requires_smtp ? npmp_email_smtp_is_configured( $settings ) : true;

	$connection_state = $smtp_ready ? 'ok' : 'error';
	$connection_label = $requires_smtp
		? ( $smtp_ready ? __( 'Credentials complete', 'nonprofit-manager' ) : __( 'Missing host, username, password, or port.', 'nonprofit-manager' ) )
		: __( 'Using the WordPress mailer.', 'nonprofit-manager' );

	$last_state  = 'info';
	$last_label  = __( 'No test emails sent yet.', 'nonprofit-manager' );
	$timestamp   = ! empty( $last_result['timestamp'] ) ? date_i18n( get_option( 'date_format' ) . ' ' . get_option( 'time_format' ), $last_result['timestamp'] ) : '';
	$last_status = $last_result['status'] ?? '';

	if ( 'success' === $last_status ) {
		$last_state = 'ok';
		$message    = __( 'Most recent email sent successfully.', 'nonprofit-manager' );
		if ( ! empty( $last_result['details']['provider'] ) && isset( $provider_choices[ $last_result['details']['provider'] ] ) ) {
			$message = sprintf(
				/* translators: %s: Provider label. */
				__( 'Most recent email sent via %s.', 'nonprofit-manager' ),
				$provider_choices[ $last_result['details']['provider'] ]
			);
		}
		$last_label = $timestamp ? sprintf( '%s %s', $message, $timestamp ) : $message;
	} elseif ( 'error' === $last_status ) {
		$last_state = 'error';
		$message    = $last_result['details']['message'] ?? __( 'The last email attempt failed.', 'nonprofit-manager' );
		$last_label = $timestamp ? sprintf( '%s %s', $message, $timestamp ) : $message;
	} elseif ( 'warning' === $last_status ) {
		$last_state = 'warning';
		$last_label = $last_result['details']['message'] ?? __( 'Email fallback in use.', 'nonprofit-manager' );
	}

	$status_colors = array(
		'ok'      => '#46b450',
		'info'    => '#2271b1',
		'warning' => '#ffb900',
		'error'   => '#dc3232',
	);

	echo '<div class="npmp-email-status-card" style="margin:20px 0;padding:20px;border:1px solid #ccd0d4;background:#fff;max-width:840px;">';
	echo '<h2 style="margin-top:0;">' . esc_html__( 'Delivery Status', 'nonprofit-manager' ) . '</h2>';
	echo '<p style="margin:0 0 16px 0;">' . esc_html__( 'Keep an eye on these indicators before sending newsletters or transactional emails.', 'nonprofit-manager' ) . '</p>';

	$items = array(
		array(
			'label' => __( 'Active provider', 'nonprofit-manager' ),
			'value' => $provider_label,
			'state' => 'info',
		),
		array(
			'label' => __( 'Connection', 'nonprofit-manager' ),
			'value' => $connection_label,
			'state' => $connection_state,
		),
		array(
			'label' => __( 'Latest delivery', 'nonprofit-manager' ),
			'value' => $last_label,
			'state' => $last_state,
		),
	);

	echo '<ul style="list-style:none;margin:0;padding:0;">';
	foreach ( $items as $item ) {
		$color = $status_colors[ $item['state'] ] ?? '#666';
		echo '<li style="display:flex;align-items:flex-start;margin-bottom:10px;">';
		echo '<span style="display:inline-block;width:10px;height:10px;margin-right:10px;margin-top:6px;border-radius:50%;background:' . esc_attr( $color ) . ';"></span>';
		echo '<div><strong>' . esc_html( $item['label'] ) . ':</strong> ' . esc_html( $item['value'] ) . '</div>';
		echo '</li>';
	}
	echo '</ul>';

	echo '<details style="margin-top:16px;">';
	echo '<summary style="cursor:pointer;font-weight:600;">' . esc_html__( 'Troubleshooting tips', 'nonprofit-manager' ) . '</summary>';
	echo '<ul style="margin-top:12px;list-style:disc;padding-left:20px;">';
	echo '<li>' . esc_html__( 'Copy the SMTP host, port, username, and password directly from your email provider to avoid typos.', 'nonprofit-manager' ) . '</li>';
	echo '<li>' . esc_html__( 'Make sure the selected encryption (TLS or SSL) matches the port your provider expects.', 'nonprofit-manager' ) . '</li>';
	echo '<li>' . esc_html__( 'Verify SPF and DKIM DNS records for the From domain so messages pass spam checks.', 'nonprofit-manager' ) . '</li>';
	echo '<li>' . esc_html__( 'After saving, send a test email below and review any error details that appear.', 'nonprofit-manager' ) . '</li>';
	echo '</ul>';
	echo '</details>';
	echo '</div>';

	if ( 'wordpress' === $provider_key ) {
		echo '<div class="notice notice-warning" style="max-width:840px;"><p>' .
			wp_kses_post(
				sprintf(
					/* translators: %s: Strong tag opening and closing. */
					__( '%1$sTip:%2$s Many hosts throttle the default WordPress mailer. Switching to a dedicated SMTP service usually improves deliverability.', 'nonprofit-manager' ),
					'<strong>',
					'</strong>'
				)
			) .
			'</p></div>';
	}
}

/* ========================================================================
 *  Email-settings admin page
 * ======================================================================== */
function npmp_render_email_settings_page() {

	if ( ! current_user_can( 'manage_options' ) ) {
		wp_die( esc_html__( 'You do not have sufficient permissions to access this page.', 'nonprofit-manager' ) );
	}

	$settings                  = npmp_email_get_settings();
	$notices                   = array();
	$turnstile_test_message    = '';
	$last_result               = npmp_email_get_last_result();
	$provider_choices          = npmp_email_get_provider_choices();
	$aws_regions               = npmp_email_get_aws_regions();
	$current_captcha_provider  = npmp_captcha_get_provider();
	$current_turnstile_enabled = (int) get_option( 'npmp_turnstile_enabled', 0 );
	$current_turnstile_site    = get_option( 'npmp_turnstile_site_key', '' );
	$current_turnstile_secret  = get_option( 'npmp_turnstile_secret_key', '' );
	$current_recaptcha_site    = get_option( 'npmp_recaptcha_site_key', '' );
	$current_recaptcha_secret  = get_option( 'npmp_recaptcha_secret_key', '' );

	if (
		isset( $_POST['npmp_turnstile_test_nonce'] ) &&
		wp_verify_nonce( sanitize_text_field( wp_unslash( $_POST['npmp_turnstile_test_nonce'] ) ), 'npmp_test_turnstile' )
	) {
		$test_result = npmp_turnstile_test_keys();
		if ( is_wp_error( $test_result ) ) {
			$turnstile_test_message = '<div class="notice notice-error"><p>' . esc_html( $test_result->get_error_message() ) . '</p></div>';
		} else {
			$turnstile_test_message = '<div class="notice notice-success"><p>' . esc_html__( 'Connection to Cloudflare Turnstile succeeded.', 'nonprofit-manager' ) . '</p></div>';
		}
	}

	if (
		isset( $_POST['npmp_email_settings_nonce'] ) &&
		wp_verify_nonce( sanitize_text_field( wp_unslash( $_POST['npmp_email_settings_nonce'] ) ), 'npmp_email_settings' )
	) {
		$new_settings = $settings;
		$errors       = array();

		$new_settings['from_name']       = sanitize_text_field( wp_unslash( $_POST['npmp_email_from_name'] ?? '' ) );
		$new_settings['from_email']      = sanitize_email( wp_unslash( $_POST['npmp_email_from_email'] ?? '' ) );
		$new_settings['force_from']      = isset( $_POST['npmp_email_force_from'] ) ? 1 : 0;
		$new_settings['set_return_path'] = isset( $_POST['npmp_email_return_path'] ) ? 1 : 0;

		$provider = sanitize_key( wp_unslash( $_POST['npmp_email_provider'] ?? 'wordpress' ) );
		if ( ! array_key_exists( $provider, $provider_choices ) ) {
			$provider = 'wordpress';
		}
		$new_settings['provider'] = $provider;

		$new_settings['smtp']['host']       = sanitize_text_field( wp_unslash( $_POST['npmp_smtp_host'] ?? '' ) );
		$new_settings['smtp']['port']       = absint( wp_unslash( $_POST['npmp_smtp_port'] ?? $new_settings['smtp']['port'] ) );
		$new_settings['smtp']['encryption'] = sanitize_key( wp_unslash( $_POST['npmp_smtp_encryption'] ?? $new_settings['smtp']['encryption'] ) );
		if ( ! in_array( $new_settings['smtp']['encryption'], array( 'none', 'ssl', 'tls' ), true ) ) {
			$new_settings['smtp']['encryption'] = 'tls';
		}
		$new_settings['smtp']['auth']     = isset( $_POST['npmp_smtp_auth'] ) ? 1 : 0;
		$new_settings['smtp']['auto_tls'] = isset( $_POST['npmp_smtp_auto_tls'] ) ? 1 : 0;
		$new_settings['smtp']['username'] = sanitize_text_field( wp_unslash( $_POST['npmp_smtp_username'] ?? '' ) );

		$password_input = isset( $_POST['npmp_smtp_password'] ) ? sanitize_text_field( wp_unslash( $_POST['npmp_smtp_password'] ) ) : '';
		if ( '' !== $password_input ) {
			$new_settings['smtp']['password'] = $password_input;
		} elseif ( empty( $new_settings['smtp']['password'] ) ) {
			$new_settings['smtp']['password'] = '';
		}

		$region = sanitize_key( wp_unslash( $_POST['npmp_aws_region'] ?? $new_settings['aws']['region'] ?? 'us-east-1' ) );
		if ( ! array_key_exists( $region, $aws_regions ) ) {
			$region = 'us-east-1';
		}
		$new_settings['aws']['region'] = $region;

		if ( empty( $new_settings['smtp']['port'] ) ) {
			$new_settings['smtp']['port'] = ( 'ssl' === $new_settings['smtp']['encryption'] ) ? 465 : 587;
		}

		if ( 'aws_ses' === $new_settings['provider'] && empty( $new_settings['smtp']['host'] ) ) {
			$new_settings['smtp']['host'] = npmp_email_get_aws_smtp_host( $region );
		}

		if ( empty( $new_settings['from_email'] ) || ! is_email( $new_settings['from_email'] ) ) {
			$errors[] = __( 'Please provide a valid "From" email address.', 'nonprofit-manager' );
		}

		if ( npmp_email_provider_requires_smtp( $new_settings ) ) {
			if ( '' === trim( $new_settings['smtp']['host'] ) ) {
				$errors[] = __( 'SMTP host is required when using SMTP delivery.', 'nonprofit-manager' );
			}
			if ( $new_settings['smtp']['port'] <= 0 ) {
				$errors[] = __( 'SMTP port must be a positive number.', 'nonprofit-manager' );
			}
			if ( $new_settings['smtp']['auth'] ) {
				if ( '' === trim( $new_settings['smtp']['username'] ) ) {
					$errors[] = __( 'SMTP username is required when authentication is enabled.', 'nonprofit-manager' );
				}
				if ( '' === trim( $new_settings['smtp']['password'] ) ) {
					$errors[] = __( 'SMTP password is required when authentication is enabled.', 'nonprofit-manager' );
				}
			}
		}

		$current_captcha_provider = sanitize_key( wp_unslash( $_POST['npmp_captcha_provider'] ?? $current_captcha_provider ) );
		if ( ! in_array( $current_captcha_provider, array( 'none', 'turnstile', 'recaptcha' ), true ) ) {
			$current_captcha_provider = 'none';
		}

		$current_turnstile_enabled = ( 'turnstile' === $current_captcha_provider && isset( $_POST['npmp_turnstile_enabled'] ) ) ? 1 : 0;
		$current_turnstile_site    = sanitize_text_field( wp_unslash( $_POST['npmp_turnstile_site_key'] ?? $current_turnstile_site ) );
		$current_turnstile_secret  = sanitize_text_field( wp_unslash( $_POST['npmp_turnstile_secret_key'] ?? $current_turnstile_secret ) );
		$current_recaptcha_site    = sanitize_text_field( wp_unslash( $_POST['npmp_recaptcha_site_key'] ?? $current_recaptcha_site ) );
		$current_recaptcha_secret  = sanitize_text_field( wp_unslash( $_POST['npmp_recaptcha_secret_key'] ?? $current_recaptcha_secret ) );

		if ( empty( $errors ) ) {
			npmp_email_update_settings( $new_settings );

			update_option( 'npmp_email_method', npmp_email_provider_requires_smtp( $new_settings ) ? 'smtp' : 'wp_mail' );
			update_option( 'npmp_email_from_email', $new_settings['from_email'] );
			update_option( 'npmp_email_from_name', $new_settings['from_name'] );
			update_option( 'npmp_smtp_host', $new_settings['smtp']['host'] );
			update_option( 'npmp_smtp_port', $new_settings['smtp']['port'] );
			update_option( 'npmp_smtp_encryption', $new_settings['smtp']['encryption'] );
			update_option( 'npmp_smtp_auth', $new_settings['smtp']['auth'] );
			update_option( 'npmp_smtp_username', $new_settings['smtp']['username'] );
			update_option( 'npmp_smtp_password', $new_settings['smtp']['password'] );

			update_option( 'npmp_captcha_provider', $current_captcha_provider );
			update_option( 'npmp_turnstile_enabled', $current_turnstile_enabled );
			update_option( 'npmp_turnstile_site_key', $current_turnstile_site );
			update_option( 'npmp_turnstile_secret_key', $current_turnstile_secret );
			update_option( 'npmp_recaptcha_site_key', $current_recaptcha_site );
			update_option( 'npmp_recaptcha_secret_key', $current_recaptcha_secret );

			$settings = $new_settings;
			$notices[] = array(
				'type'    => 'success',
				'message' => __( 'Email settings saved.', 'nonprofit-manager' ),
			);
		} else {
			$settings = $new_settings;
			$notices[] = array(
				'type'    => 'error',
				'message' => implode( '<br>', array_map( 'esc_html', $errors ) ),
			);
		}
	}

	echo '<div class="wrap"><h1>' . esc_html__( 'Email Settings', 'nonprofit-manager' ) . '</h1>';

	npmp_email_render_status_overview( $settings, $last_result );

	foreach ( $notices as $notice ) {
		$class = 'notice';
		if ( 'success' === $notice['type'] ) {
			$class .= ' notice-success';
		} elseif ( 'error' === $notice['type'] ) {
			$class .= ' notice-error';
		} else {
			$class .= ' notice-warning';
		}
		echo '<div class="' . esc_attr( $class ) . '"><p>' . wp_kses_post( $notice['message'] ) . '</p></div>';
	}

	echo '<form method="post" class="npmp-email-settings-form">';
	wp_nonce_field( 'npmp_email_settings', 'npmp_email_settings_nonce' );

	echo '<h2>' . esc_html__( 'General Settings', 'nonprofit-manager' ) . '</h2>';
	echo '<table class="form-table">';
	echo '<tr><th scope="row"><label for="npmp_email_from_name">' . esc_html__( 'From Name', 'nonprofit-manager' ) . '</label></th>';
	echo '<td><input type="text" id="npmp_email_from_name" name="npmp_email_from_name" class="regular-text" value="' . esc_attr( $settings['from_name'] ) . '">';
	echo '<p class="description">' . esc_html__( 'Displayed as the sender name in outgoing emails.', 'nonprofit-manager' ) . '</p></td></tr>';

	echo '<tr><th scope="row"><label for="npmp_email_from_email">' . esc_html__( 'From Email', 'nonprofit-manager' ) . '</label></th>';
	echo '<td><input type="email" id="npmp_email_from_email" name="npmp_email_from_email" class="regular-text" value="' . esc_attr( $settings['from_email'] ) . '" required>';
	echo '<p class="description">' . esc_html__( 'Use an email address that is authorised by your mail provider (for Amazon SES, verify this identity).', 'nonprofit-manager' ) . '</p></td></tr>';

	echo '<tr><th scope="row">' . esc_html__( 'Sender Controls', 'nonprofit-manager' ) . '</th><td>';
	echo '<label><input type="checkbox" name="npmp_email_force_from" value="1" ' . checked( ! empty( $settings['force_from'] ), true, false ) . '> ' . esc_html__( 'Force emails to use this From name & address.', 'nonprofit-manager' ) . '</label><br>';
	echo '<label><input type="checkbox" name="npmp_email_return_path" value="1" ' . checked( ! empty( $settings['set_return_path'] ), true, false ) . '> ' . esc_html__( 'Set the return-path to match the From email (helps prevent bounces).', 'nonprofit-manager' ) . '</label>';
	echo '</td></tr>';

	echo '<tr><th scope="row"><label for="npmp_email_provider">' . esc_html__( 'Delivery Provider', 'nonprofit-manager' ) . '</label></th>';
	echo '<td><select name="npmp_email_provider" id="npmp_email_provider">';
	foreach ( $provider_choices as $value => $label ) {
		echo '<option value="' . esc_attr( $value ) . '"' . selected( $settings['provider'], $value, false ) . '>' . esc_html( $label ) . '</option>';
	}
	echo '</select>';
	echo '<p class="description">' . esc_html__( 'Switch between the default WordPress mailer, a custom SMTP server, or Amazon SES SMTP credentials.', 'nonprofit-manager' ) . '</p></td></tr>';
	echo '</table>';

	echo '<div class="npmp-provider-block npmp-provider-wordpress"' . ( 'wordpress' === $settings['provider'] ? '' : ' style="display:none;"' ) . '>';
	echo '<h2>' . esc_html__( 'WordPress (wp_mail)', 'nonprofit-manager' ) . '</h2>';
	echo '<p>' . esc_html__( 'Emails are delivered using your host\'s built-in mail function. No additional configuration is required, but deliverability may vary by host.', 'nonprofit-manager' ) . '</p>';
	echo '</div>';

	$requires_smtp = npmp_email_provider_requires_smtp( $settings );
	echo '<div class="npmp-provider-block npmp-provider-smtp-common"' . ( $requires_smtp ? '' : ' style="display:none;"' ) . '>';
	echo '<h2>' . esc_html__( 'SMTP Connection', 'nonprofit-manager' ) . '</h2>';
	if ( 'smtp' === $settings['provider'] ) {
		echo '<p>' . esc_html__( 'Enter the credentials provided by your email host or service.', 'nonprofit-manager' ) . '</p>';
	} else {
		echo '<p>' . esc_html__( 'Amazon SES also uses SMTP credentials. These fields control the underlying connection.', 'nonprofit-manager' ) . '</p>';
	}
	echo '<table class="form-table">';
	echo '<tr><th scope="row"><label for="npmp_smtp_host">' . esc_html__( 'SMTP Host', 'nonprofit-manager' ) . '</label></th>';
	echo '<td><input type="text" id="npmp_smtp_host" name="npmp_smtp_host" class="regular-text" value="' . esc_attr( $settings['smtp']['host'] ) . '" placeholder="smtp.example.com"></td></tr>';

	echo '<tr><th scope="row"><label for="npmp_smtp_port">' . esc_html__( 'SMTP Port', 'nonprofit-manager' ) . '</label></th>';
	echo '<td><input type="number" id="npmp_smtp_port" name="npmp_smtp_port" class="small-text" value="' . esc_attr( $settings['smtp']['port'] ) . '">';
	echo '<p class="description">' . esc_html__( 'Common ports: 587 for TLS, 465 for SSL.', 'nonprofit-manager' ) . '</p></td></tr>';

	echo '<tr><th scope="row">' . esc_html__( 'Encryption', 'nonprofit-manager' ) . '</th><td><select name="npmp_smtp_encryption">';
	$encryption_options = array(
		'tls'  => __( 'TLS', 'nonprofit-manager' ),
		'ssl'  => __( 'SSL', 'nonprofit-manager' ),
		'none' => __( 'None', 'nonprofit-manager' ),
	);
	foreach ( $encryption_options as $value => $label ) {
		echo '<option value="' . esc_attr( $value ) . '"' . selected( $settings['smtp']['encryption'], $value, false ) . '>' . esc_html( $label ) . '</option>';
	}
	echo '</select></td></tr>';

	echo '<tr><th scope="row">' . esc_html__( 'Authentication', 'nonprofit-manager' ) . '</th><td>';
	echo '<label><input type="checkbox" name="npmp_smtp_auth" value="1" ' . checked( ! empty( $settings['smtp']['auth'] ), true, false ) . '> ' . esc_html__( 'My SMTP server requires authentication', 'nonprofit-manager' ) . '</label><br>';
	echo '<label><input type="checkbox" name="npmp_smtp_auto_tls" value="1" ' . checked( ! empty( $settings['smtp']['auto_tls'] ), true, false ) . '> ' . esc_html__( 'Enable opportunistic TLS (recommended).', 'nonprofit-manager' ) . '</label>';
	echo '</td></tr>';

	echo '<tr><th scope="row"><label for="npmp_smtp_username">' . esc_html__( 'SMTP Username', 'nonprofit-manager' ) . '</label></th>';
	echo '<td><input type="text" id="npmp_smtp_username" name="npmp_smtp_username" class="regular-text" value="' . esc_attr( $settings['smtp']['username'] ) . '"></td></tr>';

	echo '<tr><th scope="row"><label for="npmp_smtp_password">' . esc_html__( 'SMTP Password', 'nonprofit-manager' ) . '</label></th>';
	echo '<td><input type="password" id="npmp_smtp_password" name="npmp_smtp_password" class="regular-text" value="" autocomplete="new-password" placeholder="' . ( $settings['smtp']['password'] ? '********' : '' ) . '">';
	echo '<p class="description">' . esc_html__( 'Leave blank to keep the existing password.', 'nonprofit-manager' ) . '</p></td></tr>';
	echo '</table></div>';

	echo '<div class="npmp-provider-block npmp-provider-smtp"' . ( 'smtp' === $settings['provider'] ? '' : ' style="display:none;"' ) . '>';
	echo '<p>' . esc_html__( 'Tip: double-check your firewall or hosting provider allows outbound SMTP connections when using custom credentials.', 'nonprofit-manager' ) . '</p>';
	echo '</div>';

	echo '<div class="npmp-provider-block npmp-provider-aws_ses"' . ( 'aws_ses' === $settings['provider'] ? '' : ' style="display:none;"' ) . '>';
	echo '<h2>' . esc_html__( 'Amazon SES (SMTP)', 'nonprofit-manager' ) . '</h2>';
	echo '<p>' . esc_html__( 'Use your Amazon SES SMTP credentials. These are different from your AWS access keys.', 'nonprofit-manager' ) . '</p>';
	echo '<table class="form-table">';
	echo '<tr><th scope="row"><label for="npmp_aws_region">' . esc_html__( 'SES Region', 'nonprofit-manager' ) . '</label></th>';
	echo '<td><select name="npmp_aws_region" id="npmp_aws_region">';
	foreach ( $aws_regions as $value => $label ) {
		echo '<option value="' . esc_attr( $value ) . '"' . selected( $settings['aws']['region'], $value, false ) . '>' . esc_html( $label ) . '</option>';
	}
	echo '</select></td></tr>';
	echo '</table>';
	echo '<p>' . sprintf(
		/* translators: %s is an example SES SMTP host. */
		esc_html__( 'SES SMTP host will default to %s based on the region above. If you need to override it, adjust the SMTP host field in the section above.', 'nonprofit-manager' ),
		esc_html( npmp_email_get_aws_smtp_host( $settings['aws']['region'] ) )
	) . '</p>';
	echo '</div>';

	echo '<h2>' . esc_html__( 'Form Security', 'nonprofit-manager' ) . '</h2>';
	echo '<table class="form-table">';
	echo '<tr><th scope="row"><label for="npmp_captcha_provider">' . esc_html__( 'CAPTCHA Provider', 'nonprofit-manager' ) . '</label></th>';
	echo '<td><select name="npmp_captcha_provider" id="npmp_captcha_provider">';
	echo '<option value="none"' . selected( $current_captcha_provider, 'none', false ) . '>' . esc_html__( 'None (not recommended)', 'nonprofit-manager' ) . '</option>';
	echo '<option value="turnstile"' . selected( $current_captcha_provider, 'turnstile', false ) . '>' . esc_html__( 'Cloudflare Turnstile', 'nonprofit-manager' ) . '</option>';
	echo '<option value="recaptcha"' . selected( $current_captcha_provider, 'recaptcha', false ) . '>' . esc_html__( 'Google reCAPTCHA (coming soon)', 'nonprofit-manager' ) . '</option>';
	echo '</select>';
	echo '<p class="description">' . esc_html__( 'Protect your public forms against spam and abuse.', 'nonprofit-manager' ) . '</p></td></tr>';

	$turnstile_row_style = ( 'turnstile' === $current_captcha_provider ) ? '' : 'display:none;';
	echo '<tr class="captcha-turnstile"' . ( $turnstile_row_style ? ' style="' . esc_attr( $turnstile_row_style ) . '"' : '' ) . '><th scope="row">' . esc_html__( 'Turnstile Settings', 'nonprofit-manager' ) . '</th><td>';
	echo '<label><input type="checkbox" name="npmp_turnstile_enabled" value="1" ' . checked( $current_turnstile_enabled, 1, false ) . '> ' . esc_html__( 'Require Turnstile verification on public signup forms.', 'nonprofit-manager' ) . '</label><br>';
	echo '<input type="text" class="regular-text" name="npmp_turnstile_site_key" value="' . esc_attr( $current_turnstile_site ) . '" placeholder="Site key"><br>';
	echo '<input type="text" class="regular-text" name="npmp_turnstile_secret_key" value="' . esc_attr( $current_turnstile_secret ) . '" placeholder="Secret key">';
	echo '</td></tr>';

	$recaptcha_row_style = ( 'recaptcha' === $current_captcha_provider ) ? '' : 'display:none;';
	echo '<tr class="captcha-recaptcha"' . ( $recaptcha_row_style ? ' style="' . esc_attr( $recaptcha_row_style ) . '"' : '' ) . '><th scope="row">' . esc_html__( 'reCAPTCHA Settings', 'nonprofit-manager' ) . '</th><td>';
	echo '<input type="text" class="regular-text" name="npmp_recaptcha_site_key" value="' . esc_attr( $current_recaptcha_site ) . '" placeholder="Site key"><br>';
	echo '<input type="text" class="regular-text" name="npmp_recaptcha_secret_key" value="' . esc_attr( $current_recaptcha_secret ) . '" placeholder="Secret key">';
	echo '<p class="description">' . esc_html__( 'Stored for future premium integrations.', 'nonprofit-manager' ) . '</p></td></tr>';
	echo '</table>';

	echo '<p class="submit">';
	submit_button( __( 'Save Settings', 'nonprofit-manager' ), 'primary', 'submit', false );
	echo '</p>';
	echo '</form><hr>';

	if ( $turnstile_test_message ) {
		echo wp_kses_post( $turnstile_test_message );
	}

	echo '<h2>' . esc_html__( 'Test Turnstile Keys', 'nonprofit-manager' ) . '</h2>';
	echo '<p>' . esc_html__( 'Validate that your Turnstile secret can talk to Cloudflare before enabling it on public forms.', 'nonprofit-manager' ) . '</p>';
	echo '<form method="post">';
	wp_nonce_field( 'npmp_test_turnstile', 'npmp_turnstile_test_nonce' );
		$test_disabled = ( 'turnstile' !== $current_captcha_provider || ! npmp_turnstile_is_configured() );
		echo '<p><input type="submit" class="button" value="' . esc_attr__( 'Test Turnstile Keys', 'nonprofit-manager' ) . '"' . ( $test_disabled ? ' disabled' : '' ) . '></p>';
		if ( $test_disabled ) {
		echo '<p class="description">' . esc_html__( 'Enter your Turnstile keys and choose Cloudflare Turnstile above to enable this test.', 'nonprofit-manager' ) . '</p>';
	}
	echo '</form><hr>';

	echo '<h2>' . esc_html__( 'Send Test Email', 'nonprofit-manager' ) . '</h2>';
	echo '<p>' . esc_html__( 'Send yourself a message to confirm your mailer is working.', 'nonprofit-manager' ) . '</p>';

	if (
		isset( $_POST['npmp_test_email_nonce'] ) &&
		wp_verify_nonce( sanitize_text_field( wp_unslash( $_POST['npmp_test_email_nonce'] ) ), 'npmp_test_email' )
	) {
		$to      = sanitize_email( wp_unslash( $_POST['npmp_test_email'] ?? '' ) );
		$subject = sanitize_text_field( wp_unslash( $_POST['npmp_test_subject'] ?? '' ) );
		$message = sanitize_textarea_field( wp_unslash( $_POST['npmp_test_message'] ?? '' ) );

		if ( $to && $subject && $message ) {
			delete_option( 'npmp_email_last_error' );
			add_action(
				'wp_mail_failed',
				static function ( $wp_error ) {
					update_option( 'npmp_email_last_error', $wp_error );
				}
			);

			$headers = array(
				'Content-Type: text/html; charset=UTF-8',
			);

			$success = wp_mail( $to, $subject, nl2br( $message ), $headers );

			if ( $success ) {
				echo '<div class="notice notice-success"><p>' . esc_html__( 'Test email sent successfully.', 'nonprofit-manager' ) . '</p></div>';
			} else {
				echo '<div class="notice notice-error"><p>' . esc_html__( 'Failed to send the test email.', 'nonprofit-manager' ) . '</p></div>';
				if ( $err = get_option( 'npmp_email_last_error' ) ) {
					$err_msg = is_wp_error( $err ) ? $err->get_error_message() : wp_json_encode( $err );
					echo '<pre style="background:#fff;border:1px solid #ccc;padding:10px;max-height:300px;overflow:auto;">' . esc_html( $err_msg ) . '</pre>';
				}
			}
		}
	}

	echo '<form method="post">';
	wp_nonce_field( 'npmp_test_email', 'npmp_test_email_nonce' );
	echo '<table class="form-table">';
	echo '<tr><th scope="row"><label for="npmp_test_email">' . esc_html__( 'Recipient Email', 'nonprofit-manager' ) . '</label></th>';
	echo '<td><input type="email" id="npmp_test_email" name="npmp_test_email" class="regular-text" value="' . esc_attr( wp_get_current_user()->user_email ) . '" required></td></tr>';

	echo '<tr><th scope="row"><label for="npmp_test_subject">' . esc_html__( 'Subject', 'nonprofit-manager' ) . '</label></th>';
	echo '<td><input type="text" id="npmp_test_subject" name="npmp_test_subject" class="regular-text" value="' . esc_attr__( 'Test Email from Nonprofit Manager', 'nonprofit-manager' ) . '" required></td></tr>';

	echo '<tr><th scope="row"><label for="npmp_test_message">' . esc_html__( 'Message', 'nonprofit-manager' ) . '</label></th>';
	echo '<td><textarea id="npmp_test_message" name="npmp_test_message" rows="5" class="large-text" required>' . esc_textarea( __( "This is a test email sent from the Nonprofit Manager plugin.\n\nIf you're receiving this, your email settings are working correctly.", 'nonprofit-manager' ) ) . '</textarea></td></tr>';
	echo '</table>';
	submit_button( __( 'Send Test Email', 'nonprofit-manager' ), 'secondary' );
	echo '</form>';

		echo '</div>';
	}
/* ========================================================================
 *  Placeholder Email-delivery page
 * ======================================================================== */
if ( ! function_exists( 'npmp_render_email_delivery_page' ) ) {
	function npmp_render_email_delivery_page() {}
}

/* ========================================================================
 *  Member-manager class (shared across admin pages)
 * ======================================================================== */
class NPMP_Member_Manager {

	private static $instance = null;

	/**
	 * Singleton accessor.
	 *
	 * @return self
	 */
	public static function get_instance() {
		return self::$instance ?: ( self::$instance = new self() );
	}

	/**
	 * Map logical member fields to stored post meta keys.
	 *
	 * @return array
	 */
	private function meta_keys() {
		return array(
			'email'            => 'npmp_email',
			'membership_level' => 'npmp_membership_level',
			'status'           => 'npmp_status',
			'phone'            => 'npmp_phone',
			'mobile'           => 'npmp_mobile',
			'address_line1'    => 'npmp_address_line1',
			'address_line2'    => 'npmp_address_line2',
			'city'             => 'npmp_city',
			'state'            => 'npmp_state',
			'postal_code'      => 'npmp_postal_code',
			'country'          => 'npmp_country',
			'tags'             => 'npmp_tags',
			'source'           => 'npmp_source',
			'last_contacted'   => 'npmp_last_contacted',
			'notes'            => 'npmp_notes',
			'last_donation_at' => 'npmp_last_donation_at',
			'donation_count'   => 'npmp_donation_count',
			'donation_total'   => 'npmp_donation_total',
		);
	}

	/**
	 * Allowed columns for updates.
	 *
	 * @return array
	 */
	private function allowed_columns() {
		return array(
			'name',
			'email',
			'membership_level',
			'status',
			'phone',
			'mobile',
			'address_line1',
			'address_line2',
			'city',
			'state',
			'postal_code',
			'country',
			'tags',
			'source',
			'last_contacted',
			'notes',
			'last_donation_at',
			'donation_count',
			'donation_total',
		);
	}

	/**
	 * Available member statuses.
	 *
	 * @return array
	 */
	public function get_statuses() {
		return array(
			'subscribed'   => __( 'Active', 'nonprofit-manager' ),
			'pending'      => __( 'Pending', 'nonprofit-manager' ),
			'donor'        => __( 'Donor', 'nonprofit-manager' ),
			'volunteer'    => __( 'Volunteer', 'nonprofit-manager' ),
			'partner'      => __( 'Partner', 'nonprofit-manager' ),
			'inactive'     => __( 'Inactive', 'nonprofit-manager' ),
			'unsubscribed' => __( 'Unsubscribed', 'nonprofit-manager' ),
		);
	}

	/**
	 * Normalise a status value.
	 *
	 * @param string $status Raw status.
	 * @return string
	 */
	private function normalize_status( $status ) {
		$status  = sanitize_key( $status );
		$choices = $this->get_statuses();
		if ( array_key_exists( $status, $choices ) ) {
			return $status;
		}
		return 'subscribed';
	}

	/**
	 * Normalise a tag string.
	 *
	 * @param string|array $tags Raw tags.
	 * @return string
	 */
	private function normalize_tags( $tags ) {
		if ( is_array( $tags ) ) {
			$tags = implode( ',', $tags );
		}
		$list = array_filter(
			array_map(
				static function ( $tag ) {
					$tag = trim( $tag );
					if ( '' === $tag ) {
						return '';
					}
					return sanitize_text_field( $tag );
				},
				preg_split( '/[,;]/', (string) $tags )
			)
		);

		$list = array_unique( $list );
		return implode( ',', $list );
	}

	/**
	 * Sanitise incoming member data.
	 *
	 * @param array  $data    Raw data.
	 * @param string $context create|update|system.
	 * @return array
	 */
	private function sanitize_member_data( $data, $context = 'update' ) {
		$clean   = array();
		$allowed = $this->allowed_columns();

		foreach ( (array) $data as $key => $value ) {
			if ( ! in_array( $key, $allowed, true ) ) {
				continue;
			}

			switch ( $key ) {
				case 'email':
					$value = sanitize_email( $value );
					if ( empty( $value ) ) {
						continue 2;
					}
					break;
				case 'notes':
					$value = wp_kses_post( $value );
					break;
				case 'tags':
					$value = $this->normalize_tags( $value );
					break;
				case 'status':
					$value = $this->normalize_status( $value );
					break;
				case 'donation_total':
					$value = floatval( $value );
					break;
				case 'donation_count':
					$value = intval( $value );
					break;
				case 'last_contacted':
				case 'last_donation_at':
					$value = $value ? gmdate( 'Y-m-d H:i:s', strtotime( $value ) ) : null;
					break;
				default:
					$value = sanitize_text_field( $value );
					break;
			}

			$clean[ $key ] = $value;
		}

		if ( 'create' === $context ) {
			if ( ! isset( $clean['status'] ) ) {
				$clean['status'] = 'subscribed';
			}
		}

		return $clean;
	}

	/**
	 * Build a member object from a post.
	 *
	 * @param WP_Post $post Contact post.
	 * @return object
	 */
	private function hydrate_member_from_post( $post ) {
		$meta_keys = $this->meta_keys();
		$meta      = array();

		foreach ( $meta_keys as $property => $meta_key ) {
			$meta[ $property ] = get_post_meta( $post->ID, $meta_key, true );
		}

		$member = (object) array(
			'id'               => $post->ID,
			'name'             => $post->post_title,
			'email'            => isset( $meta['email'] ) ? sanitize_email( $meta['email'] ) : '',
			'membership_level' => isset( $meta['membership_level'] ) ? sanitize_text_field( $meta['membership_level'] ) : '',
			'status'           => isset( $meta['status'] ) ? $this->normalize_status( $meta['status'] ) : 'subscribed',
			'phone'            => isset( $meta['phone'] ) ? $meta['phone'] : '',
			'mobile'           => isset( $meta['mobile'] ) ? $meta['mobile'] : '',
			'address_line1'    => isset( $meta['address_line1'] ) ? $meta['address_line1'] : '',
			'address_line2'    => isset( $meta['address_line2'] ) ? $meta['address_line2'] : '',
			'city'             => isset( $meta['city'] ) ? $meta['city'] : '',
			'state'            => isset( $meta['state'] ) ? $meta['state'] : '',
			'postal_code'      => isset( $meta['postal_code'] ) ? $meta['postal_code'] : '',
			'country'          => isset( $meta['country'] ) ? $meta['country'] : '',
			'tags'             => isset( $meta['tags'] ) ? $meta['tags'] : '',
			'source'           => isset( $meta['source'] ) ? $meta['source'] : '',
			'last_contacted'   => isset( $meta['last_contacted'] ) ? $meta['last_contacted'] : '',
			'notes'            => isset( $meta['notes'] ) ? $meta['notes'] : '',
			'last_donation_at' => isset( $meta['last_donation_at'] ) ? $meta['last_donation_at'] : '',
			'donation_count'   => isset( $meta['donation_count'] ) ? (int) $meta['donation_count'] : 0,
			'donation_total'   => isset( $meta['donation_total'] ) ? (float) $meta['donation_total'] : 0.0,
			'created_at'       => $post->post_date,
			'updated_at'       => $post->post_modified,
		);

		if ( empty( $member->name ) && $member->email ) {
			$member->name = $member->email;
		}

		return $member;
	}

	/**
	 * Store a member in the object cache.
	 *
	 * @param object $member Member object.
	 * @return void
	 */
	private function cache_member( $member ) {
		if ( ! $member || empty( $member->id ) ) {
			return;
		}

		wp_cache_set( 'npmp_member_' . $member->id, $member, 'npmp_members', 300 );

		if ( ! empty( $member->email ) ) {
			wp_cache_set( 'npmp_member_email_' . strtolower( $member->email ), $member, 'npmp_members', 300 );
		}
	}

	/**
	 * Clear cached member data.
	 *
	 * @param int    $member_id Member ID.
	 * @param string $email     Email address.
	 * @return void
	 */
	private function clear_cache( $member_id = 0, $email = '' ) {
		if ( $member_id ) {
			wp_cache_delete( 'npmp_member_' . $member_id, 'npmp_members' );
		}
		if ( $email ) {
			wp_cache_delete( 'npmp_member_email_' . strtolower( $email ), 'npmp_members' );
		}
		wp_cache_delete( 'npmp_members_all', 'npmp_members' );
	}

	/**
	 * Build WP_Query arguments for member lookups.
	 *
	 * @param array $args Raw arguments.
	 * @return array
	 */
	private function build_query_args( $args = array() ) {
		$args = wp_parse_args(
			$args,
			array(
				'status'   => '',
				'level'    => '',
				'tag'      => '',
				'search'   => '',
				'orderby'  => 'created_at',
				'order'    => 'DESC',
				'paged'    => 1,
				'per_page' => 20,
			)
		);

		$per_page = (int) $args['per_page'];
		if ( 0 === $per_page ) {
			$per_page = 20;
		}

		$query = array(
			'post_type'      => 'npmp_contact',
			'post_status'    => array( 'publish' ),
			'paged'          => max( 1, absint( $args['paged'] ) ),
			'posts_per_page' => $per_page,
			'no_found_rows'  => false,
		);

		if ( -1 === $per_page ) {
			$query['posts_per_page'] = -1;
			$query['no_found_rows']  = true;
		}

		// phpcs:ignore WordPress.DB.SlowDBQuery.slow_db_query_meta_query -- CRM export filters rely on post meta values.
		$meta_query = array( 'relation' => 'AND' );

		if ( $args['status'] && 'all' !== $args['status'] ) {
			$meta_query[] = array(
				'key'   => 'npmp_status',
				'value' => $this->normalize_status( $args['status'] ),
				'compare' => '=',
			);
		}

		if ( $args['level'] ) {
			$meta_query[] = array(
				'key'   => 'npmp_membership_level',
				'value' => sanitize_text_field( $args['level'] ),
				'compare' => '=',
			);
		}

		if ( $args['tag'] ) {
			$meta_query[] = array(
				'key'     => 'npmp_tags',
				'value'   => sanitize_text_field( $args['tag'] ),
				'compare' => 'LIKE',
			);
		}

		if ( $args['search'] ) {
			$query['s'] = $args['search'];
			$meta_query[] = array(
				'relation' => 'OR',
				array(
					'key'     => 'npmp_email',
					'value'   => $args['search'],
					'compare' => 'LIKE',
				),
				array(
					'key'     => 'npmp_tags',
					'value'   => $args['search'],
					'compare' => 'LIKE',
				),
			);
		}

		if ( count( $meta_query ) > 1 ) {
			// phpcs:ignore WordPress.DB.SlowDBQuery.slow_db_query_meta_query -- CRM export filters rely on post meta values.
			$query['meta_query'] = $meta_query;
		}

		$orderby = sanitize_key( $args['orderby'] );
		$order   = strtoupper( $args['order'] );
		if ( ! in_array( $order, array( 'ASC', 'DESC' ), true ) ) {
			$order = 'DESC';
		}

		switch ( $orderby ) {
			case 'name':
				$query['orderby'] = 'title';
				break;
			case 'status':
				$query['orderby']  = 'meta_value';
				// phpcs:ignore WordPress.DB.SlowDBQuery.slow_db_query_meta_key -- Sorting by status relies on member metadata.
				$query['meta_key'] = 'npmp_status';
				break;
			case 'membership_level':
				$query['orderby']  = 'meta_value';
				// phpcs:ignore WordPress.DB.SlowDBQuery.slow_db_query_meta_key -- Sorting by membership level relies on member metadata.
				$query['meta_key'] = 'npmp_membership_level';
				break;
			case 'donation_total':
				$query['orderby']  = 'meta_value_num';
				// phpcs:ignore WordPress.DB.SlowDBQuery.slow_db_query_meta_key -- Sorting by donation total relies on member metadata.
				$query['meta_key'] = 'npmp_donation_total';
				break;
			case 'last_donation_at':
				$query['orderby']   = 'meta_value';
				// phpcs:ignore WordPress.DB.SlowDBQuery.slow_db_query_meta_key -- Sorting by last donation timestamp relies on member metadata.
				$query['meta_key']  = 'npmp_last_donation_at';
				$query['meta_type'] = 'DATETIME';
				break;
			case 'created_at':
			default:
				$query['orderby'] = 'date';
				break;
		}

		$query['order'] = $order;

		return $query;
	}

	/**
	 * Retrieve a member by ID.
	 *
	 * @param int $id Member ID.
	 * @return object|null
	 */
	public function get_member_by_id( $id ) {
		$id = absint( $id );
		if ( ! $id ) {
			return null;
		}

		$cache_key = 'npmp_member_' . $id;
		$member    = wp_cache_get( $cache_key, 'npmp_members' );

		if ( false !== $member ) {
			return $member;
		}

		$post = get_post( $id );
		if ( ! $post || 'npmp_contact' !== $post->post_type || 'publish' !== $post->post_status ) {
			return null;
		}

		$member = $this->hydrate_member_from_post( $post );
		$this->cache_member( $member );

		return $member;
	}

	/**
	 * Retrieve a member by email address.
	 *
	 * @param string $email Email.
	 * @return object|null
	 */
	public function get_member_by_email( $email ) {
		$email = sanitize_email( $email );
		if ( ! $email ) {
			return null;
		}

		$cache_key = 'npmp_member_email_' . strtolower( $email );
		$member    = wp_cache_get( $cache_key, 'npmp_members' );

		if ( false !== $member ) {
			return $member;
		}

		$query = new WP_Query(
			array(
				'post_type'      => 'npmp_contact',
				'post_status'    => 'publish',
				'posts_per_page' => 1,
				'no_found_rows'  => true,
				// phpcs:ignore WordPress.DB.SlowDBQuery.slow_db_query_meta_query -- Member lookup by email depends on meta storage.
				'meta_query'     => array(
					array(
						'key'   => 'npmp_email',
						'value' => $email,
						'compare' => '=',
					),
				),
			)
		);

		if ( empty( $query->posts ) ) {
			return null;
		}

		$member = $this->hydrate_member_from_post( $query->posts[0] );
		$this->cache_member( $member );

		return $member;
	}

	/**
	 * Determine if an email already exists.
	 *
	 * @param string $email Email address.
	 * @return bool
	 */
	public function email_exists( $email ) {
		return (bool) $this->get_member_by_email( $email );
	}

	/**
	 * Add a new member.
	 *
	 * @param array $data Member data.
	 * @return int|WP_Error
	 */
	public function add_member( $data ) {
		$clean = $this->sanitize_member_data( $data, 'create' );

		 if ( empty( $clean['email'] ) ) {
			return new WP_Error( 'npmp_missing_email', __( 'An email address is required for every contact.', 'nonprofit-manager' ) );
		 }

		if ( $this->email_exists( $clean['email'] ) ) {
			return new WP_Error( 'npmp_member_exists', __( 'A contact with this email already exists.', 'nonprofit-manager' ) );
		}

		$clean = wp_parse_args(
			$clean,
			array(
				'name'             => '',
				'membership_level' => '',
				'status'           => 'subscribed',
				'source'           => 'manual',
			)
		);

		$name = $clean['name'];
		unset( $clean['name'] );

		$meta_keys  = $this->meta_keys();
		$meta_input = array();

		foreach ( $clean as $property => $value ) {
			if ( ! array_key_exists( $property, $meta_keys ) ) {
				continue;
			}

			if ( null === $value ) {
				continue;
			}

			$meta_input[ $meta_keys[ $property ] ] = $value;
		}

		$postarr = array(
			'post_type'   => 'npmp_contact',
			'post_status' => 'publish',
			'post_title'  => $name ? $name : $clean['email'],
			'meta_input'  => $meta_input,
		);

		$post_id = wp_insert_post( $postarr, true );

		if ( is_wp_error( $post_id ) ) {
			return $post_id;
		}

		$member = $this->get_member_by_id( $post_id );
		$this->cache_member( $member );

		return $post_id;
	}

	/**
	 * Update an existing member.
	 *
	 * @param int   $id   Member ID.
	 * @param array $data Data to update.
	 * @return bool|WP_Error
	 */
	public function update_member( $id, $data ) {
		$member = $this->get_member_by_id( $id );
		if ( ! $member ) {
			return new WP_Error( 'npmp_member_not_found', __( 'Contact not found.', 'nonprofit-manager' ) );
		}

		$clean = $this->sanitize_member_data( $data, 'update' );

		if ( isset( $clean['email'] ) && $clean['email'] && $clean['email'] !== $member->email && $this->email_exists( $clean['email'] ) ) {
			return new WP_Error( 'npmp_member_exists', __( 'Another contact already uses that email address.', 'nonprofit-manager' ) );
		}

		if ( empty( $clean ) ) {
			return true;
		}

		$dirty_email = $member->email;
		$post_update = array( 'ID' => $member->id );

		if ( isset( $clean['name'] ) ) {
			$post_update['post_title'] = $clean['name'] ? $clean['name'] : ( $clean['email'] ?? $member->email );
			unset( $clean['name'] );
		}

		if ( count( $post_update ) > 1 ) {
			$result = wp_update_post( $post_update, true );
			if ( is_wp_error( $result ) ) {
				return $result;
			}
		}

		$meta_keys = $this->meta_keys();

		foreach ( $meta_keys as $property => $meta_key ) {
			if ( ! array_key_exists( $property, $clean ) ) {
				continue;
			}

			$value = $clean[ $property ];

			if ( null === $value || '' === $value ) {
				delete_post_meta( $member->id, $meta_key );
			} else {
				update_post_meta( $member->id, $meta_key, $value );
			}
		}

		$new_email = $clean['email'] ?? $member->email;
		$this->clear_cache( $member->id, $dirty_email );
		$this->cache_member( $this->get_member_by_id( $member->id ) );

		return true;
	}

	/**
	 * Upsert a member record using the email address.
	 *
	 * @param array $data Member data.
	 * @return int|WP_Error
	 */
	public function upsert_member( $data ) {
		$email = sanitize_email( $data['email'] ?? '' );
		if ( ! $email ) {
			return new WP_Error( 'npmp_missing_email', __( 'An email address is required.', 'nonprofit-manager' ) );
		}

		$existing = $this->get_member_by_email( $email );
		if ( $existing ) {
			$result = $this->update_member( $existing->id, $data );
			return is_wp_error( $result ) ? $result : $existing->id;
		}

		return $this->add_member( $data );
	}

	/**
	 * Delete a member permanently.
	 *
	 * @param int $id Member ID.
	 * @return int|false
	 */
	public function delete_member( $id ) {
		$member = $this->get_member_by_id( $id );
		if ( ! $member ) {
			return false;
		}

		$result = wp_delete_post( $member->id, true );
		if ( ! $result ) {
			return false;
		}

		$this->clear_cache( $member->id, $member->email );

		return 1;
	}

	/**
	 * Delete multiple members.
	 *
	 * @param array $ids Member IDs.
	 * @return int
	 */
	public function delete_members( $ids ) {
		$deleted = 0;
		foreach ( (array) $ids as $id ) {
			$deleted += (int) $this->delete_member( $id );
		}
		return $deleted;
	}

	/**
	 * Return all members.
	 *
	 * @return array
	 */
	public function get_all_members() {
		return $this->get_members( array( 'per_page' => -1 ) );
	}

	/**
	 * Retrieve members with optional filters.
	 *
	 * @param array $args Query arguments.
	 * @return array
	 */
	public function get_members( $args = array() ) {
		$query_args = $this->build_query_args( $args );
		$query      = new WP_Query( $query_args );
		$members    = array();

		foreach ( $query->posts as $post ) {
			$member = $this->hydrate_member_from_post( $post );
			$this->cache_member( $member );
			$members[] = $member;
		}

		return $members;
	}

	/**
	 * Count members matching the specified filters.
	 *
	 * @param array $args Filters.
	 * @return int
	 */
	public function count_members( $args = array() ) {
		$query_args = $this->build_query_args( $args );
		$query_args['posts_per_page'] = 1;
		$query_args['no_found_rows']  = false;
		$query_args['fields']         = 'ids';

		$query = new WP_Query( $query_args );

		return (int) $query->found_posts;
	}

	/**
	 * Count members per segment.
	 *
	 * @return array
	 */
	public function count_by_level() {
		$members = $this->get_members(
			array(
				'per_page' => -1,
			)
		);

		$count = array();

		foreach ( $members as $member ) {
			$level = isset( $member->membership_level ) ? $member->membership_level : '';
			$key   = $level ? $level : '';
			if ( ! isset( $count[ $key ] ) ) {
				$count[ $key ] = 0;
			}
			$count[ $key ] ++;
		}

		return $count;
	}

	/**
	 * Status summary used on the dashboard.
	 *
	 * @return array
	 */
	public function get_status_counts() {
		$query = new WP_Query(
			array(
				'post_type'      => 'npmp_contact',
				'post_status'    => 'publish',
				'posts_per_page' => -1,
				'fields'         => 'ids',
				'no_found_rows'  => true,
			)
		);

		$stats = array();

		foreach ( $query->posts as $post_id ) {
			$status = get_post_meta( $post_id, 'npmp_status', true );
			if ( ! $status ) {
				$status = 'subscribed';
			}
			if ( ! isset( $stats[ $status ] ) ) {
				$stats[ $status ] = 0;
			}
			$stats[ $status ] ++;
		}

		foreach ( $this->get_statuses() as $key => $label ) { // phpcs:ignore VariableAnalysis.CodeAnalysis.VariableAnalysis.UnusedVariable
			if ( ! isset( $stats[ $key ] ) ) {
				$stats[ $key ] = 0;
			}
		}

		return $stats;
	}

	/**
	 * Retrieve a list of tags.
	 *
	 * @return array
	 */
	public function get_tags_list() {
		$members = $this->get_members(
			array(
				'per_page' => -1,
			)
		);

		$tags = array();

		foreach ( $members as $member ) {
			if ( empty( $member->tags ) ) {
				continue;
			}

			foreach ( explode( ',', (string) $member->tags ) as $tag ) {
				$tag = trim( $tag );
				if ( '' !== $tag ) {
					$tags[ $tag ] = $tag;
				}
			}
		}

		ksort( $tags );

		return array_values( $tags );
	}

	/**
	 * Update the last contacted timestamp.
	 *
	 * @param int         $member_id Member ID.
	 * @param string|null $timestamp Timestamp.
	 * @return void
	 */
	public function set_last_contacted( $member_id, $timestamp = null ) {
		$timestamp = $timestamp ? gmdate( 'Y-m-d H:i:s', strtotime( $timestamp ) ) : current_time( 'mysql' );
		$this->update_member(
			$member_id,
			array(
				'last_contacted' => $timestamp,
			)
		);
	}

	/**
	 * Retrieve high-level financial metrics from the donations table.
	 *
	 * @return array
	 */
	public function get_financial_overview() {
		$manager    = class_exists( 'NPMP_Donation_Manager' ) ? NPMP_Donation_Manager::get_instance() : null;
		$donations  = $manager ? $manager->get_all_donations() : array();
		$total      = 0.0;
		$count      = 0;
		$recent     = 0.0;
		$cutoff     = strtotime( '-30 days' );

		foreach ( $donations as $donation_post ) {
			$amount = (float) get_post_meta( $donation_post->ID, NPMP_Donation_Manager::META_AMOUNT, true );
			if ( $amount <= 0 ) {
				continue;
			}

			$count ++;
			$total += $amount;

			$timestamp = get_post_time( 'U', true, $donation_post );
			if ( $timestamp >= $cutoff ) {
				$recent += $amount;
			}
		}

		return array(
			'total_amount'       => $total,
			'total_transactions' => $count,
			'thirty_day_amount'  => $recent,
		);
	}

	/**
	 * Count members who have recorded donations.
	 *
	 * @return int
	 */
	public function count_donors() {
		global $wpdb;

		$sql = $wpdb->prepare(
			"SELECT COUNT(*)
			 FROM {$wpdb->postmeta} pm
			 INNER JOIN {$wpdb->posts} p ON p.ID = pm.post_id
			 WHERE pm.meta_key = %s
			   AND CAST(pm.meta_value AS UNSIGNED) > 0
			   AND p.post_type = %s
			   AND p.post_status = %s",
			'npmp_donation_count',
			'npmp_contact',
			'publish'
		 );

		return (int) $wpdb->get_var( $sql ); // phpcs:ignore WordPress.DB.DirectDatabaseQuery.DirectQuery,WordPress.DB.DirectDatabaseQuery.NoCaching,WordPress.DB.PreparedSQL.NotPrepared
	}

	/**
	 * Retrieve recently active donors.
	 *
	 * @param int $limit Number of donors.
	 * @return array
	 */
	public function get_recent_donors( $limit = 5 ) {
		$limit = absint( $limit );
		if ( ! $limit ) {
			$limit = 5;
		}

		$query = new WP_Query(
			array(
				'post_type'      => 'npmp_contact',
				'post_status'    => 'publish',
				'posts_per_page' => $limit,
				// phpcs:ignore WordPress.DB.SlowDBQuery.slow_db_query_meta_key -- Recent donors list is ordered by donation timestamp meta.
				'meta_key'       => 'npmp_last_donation_at',
				'orderby'        => 'meta_value',
				'order'          => 'DESC',
				// phpcs:ignore WordPress.DB.SlowDBQuery.slow_db_query_meta_query -- Filtering donors by donation count relies on meta data.
				'meta_query'     => array(
					array(
						'key'     => 'npmp_donation_count',
						'value'   => 0,
						'compare' => '>',
						'type'    => 'NUMERIC',
					),
				),
			)
		);

		$donors = array();

		foreach ( $query->posts as $post ) {
			$member = $this->hydrate_member_from_post( $post );
			$this->cache_member( $member );
			$donors[] = $member;
		}

		return $donors;
	}

	/**
	 * Record a donation against the CRM.
	 *
	 * @param array $donation Donation data.
	 * @return void
	 */
	public function record_donation( $donation ) {
		$email = sanitize_email( $donation['email'] ?? '' );
		if ( ! $email ) {
			return;
		}

		$member      = $this->get_member_by_email( $email );
		$member_id   = $member ? $member->id : 0;
		$donor_name  = sanitize_text_field( $donation['name'] ?? '' );
		$created_at  = ! empty( $donation['created_at'] ) ? gmdate( 'Y-m-d H:i:s', strtotime( $donation['created_at'] ) ) : current_time( 'mysql' );
		$gateway     = sanitize_text_field( $donation['gateway'] ?? 'donation' );

		if ( ! $member ) {
			$result = $this->add_member(
				array(
					'email'            => $email,
					'name'             => $donor_name,
					'status'           => 'donor',
					'source'           => $gateway,
					'membership_level' => '',
				)
			);

			if ( is_wp_error( $result ) ) {
				return;
			}

			$member_id = $result;
		} else {
			$update = array();

			if ( $donor_name && empty( $member->name ) ) {
				$update['name'] = $donor_name;
			}

			if ( ! in_array( $member->status, array( 'unsubscribed', 'inactive' ), true ) ) {
				$update['status'] = 'donor';
			}

			if ( $gateway && empty( $member->source ) ) {
				$update['source'] = $gateway;
			}

			if ( $update ) {
				$this->update_member( $member_id, $update );
			}
		}

		$this->update_donation_totals( $member_id, $email, $created_at );
	}

	/**
	 * Update donation statistics for a member.
	 *
	 * @param int    $member_id Member ID.
	 * @param string $email     Email.
	 * @param string $latest    Timestamp of most recent donation.
	 * @return void
	 */
	private function update_donation_totals( $member_id, $email, $latest ) {
		if ( ! class_exists( 'NPMP_Donation_Manager' ) ) {
			return;
		}

		$totals = NPMP_Donation_Manager::get_instance()->get_totals_for_email( $email );

		$this->update_member(
			$member_id,
			array(
				'donation_count'   => (int) $totals['count'],
				'donation_total'   => (float) $totals['total'],
				'last_donation_at' => $totals['last'] ? gmdate( 'Y-m-d H:i:s', strtotime( $totals['last'] ) ) : $latest,
			)
		);
	}

	/**
	 * Retrieve donation records for a member.
	 *
	 * @param object $member Member object.
	 * @param int    $limit  Number of donations to fetch.
	 * @return array
	 */
	public function get_member_donations( $member, $limit = 20 ) {
		if ( ! $member || empty( $member->email ) ) {
			return array();
		}

		$query = new WP_Query(
			array(
				'post_type'      => NPMP_Donation_Manager::POST_TYPE,
				'post_status'    => 'publish',
				'posts_per_page' => absint( $limit ),
				'orderby'        => 'date',
				'order'          => 'DESC',
				// phpcs:ignore WordPress.DB.SlowDBQuery.slow_db_query_meta_query -- Donation records are keyed by donor email in post meta.
				'meta_query'     => array(
					array(
						'key'   => NPMP_Donation_Manager::META_EMAIL,
						'value' => sanitize_email( $member->email ),
					),
				),
			)
		);

		$donations = array();

		foreach ( $query->posts as $post ) {
			$donations[] = (object) array(
				'id'        => $post->ID,
				'amount'    => (float) get_post_meta( $post->ID, NPMP_Donation_Manager::META_AMOUNT, true ),
				'frequency' => get_post_meta( $post->ID, NPMP_Donation_Manager::META_FREQUENCY, true ),
				'gateway'   => get_post_meta( $post->ID, NPMP_Donation_Manager::META_GATEWAY, true ),
				'created_at'=> get_post_time( 'Y-m-d H:i:s', true, $post ),
			);
		}

		return $donations;
	}
}
